# System Table

## 表指定的系统表

* 表指定的系统表包含每个表的元数据和信息，例如创建的快照和正在使用的options。用户可以通过批量查询访问系统表。当前Flink、Spark、Trino和StarRocks都支持查询系统表:

```sql
-- spark sql里需要指定``查询系统表，Flink中非系统关键字无需``,建议查询系统表统一加上``
SELECT * FROM my_catalog.my_db.`my_table$snapshots`;
```

### Snapshots表

* 可以通过snapshot表来查询snapshot的历史信息，包含这个snapshot的记录条数

```sql
SELECT * FROM `test1$snapshots`;

/*
+----+----------------------+----------------------+--------------------------------+----------------------+--------------------------------+-------------------------+--------------------------------+--------------------------------+--------------------------------+----------------------+----------------------+------------------------+----------------------+
| op |          snapshot_id |            schema_id |                    commit_user |    commit_identifier |                    commit_kind |             commit_time |             base_manifest_list |            delta_manifest_list |        changelog_manifest_list |   total_record_count |   delta_record_count | changelog_record_count |            watermark |
+----+----------------------+----------------------+--------------------------------+----------------------+--------------------------------+-------------------------+--------------------------------+--------------------------------+--------------------------------+----------------------+----------------------+------------------------+----------------------+
| +I |                    1 |                    0 | b37669f9-b10c-4cef-a93c-281... |  9223372036854775807 |                         APPEND | 2024-07-25 19:32:15.142 | manifest-list-ad2de2e4-0128... | manifest-list-ad2de2e4-0128... |                         <NULL> |                    1 |                    1 |                      0 | -9223372036854775808 |
| +I |                    2 |                    0 | 531d4222-ab99-4e9b-a26a-22d... |  9223372036854775807 |                         APPEND | 2024-07-31 19:28:36.812 | manifest-list-4f384451-97e9... | manifest-list-4f384451-97e9... |                         <NULL> |                    2 |                    1 |                      0 | -9223372036854775808 |
| +I |                    3 |                    0 | 5bc607f6-14a6-451f-9711-48c... |  9223372036854775807 |                         APPEND | 2024-07-31 19:29:02.977 | manifest-list-3ce8f366-6bba... | manifest-list-3ce8f366-6bba... |                         <NULL> |                    3 |                    1 |                      0 | -9223372036854775808 |
| +I |                    4 |                    0 | 20ed6d5c-fb41-4579-b198-6d5... |  9223372036854775807 |                         APPEND | 2024-07-31 20:40:39.784 | manifest-list-096a31fc-4300... | manifest-list-096a31fc-4300... |                         <NULL> |                    4 |                    1 |                      0 | -9223372036854775808 |
| +I |                    5 |                    0 | be7d020a-03c1-43f1-a57e-171... |  9223372036854775807 |                        COMPACT | 2024-08-05 19:51:19.601 | manifest-list-f00239a5-35db... | manifest-list-f00239a5-35db... |                         <NULL> |                    1 |                   -3 |                      0 | -9223372036854775808 |
+----+----------------------+----------------------+--------------------------------+----------------------+--------------------------------+-------------------------+--------------------------------+--------------------------------+--------------------------------+----------------------+----------------------+------------------------+----------------------+
*/
```

### Schemas表

* 可以通过schemas表查询该表的历史的schema

```sql
SELECT * FROM `test1$schemas`;
/*
+----+----------------------+--------------------------------+--------------------------------+--------------------------------+--------------------------------+--------------------------------+-------------------------+
| op |            schema_id |                         fields |                 partition_keys |                   primary_keys |                        options |                        comment |             update_time |
+----+----------------------+--------------------------------+--------------------------------+--------------------------------+--------------------------------+--------------------------------+-------------------------+
| +I |                    0 | [{"id":0,"name":"id","type"... |                             [] |                         ["id"] |                             {} |                                | 2024-07-25 19:32:05.460 |
+----+----------------------+--------------------------------+--------------------------------+--------------------------------+--------------------------------+--------------------------------+-------------------------+
*/
```

* 可以join snapshot表和schema表以获得给定snapshot的字段。

```sql
SELECT s.snapshot_id, t.schema_id, t.fields 
    FROM `test1$snapshots` s JOIN `test1$schemas` t 
    ON s.schema_id=t.schema_id where s.snapshot_id=5;
```

### Options表

* 查询表的配置信息，这些信息是从DDL中通过options指定的。未显示的选项将是默认值

```sql
SELECT * FROM `test1$options`;
/*
+------------------------+--------------------+
|         key            |        value       |
+------------------------+--------------------+
| snapshot.time-retained |         5 h        |
+------------------------+--------------------+
1 rows in set
*/
```

### Audit log表

* 如果需要audit表的变更日志，可以使用`audit_log`系统表。通过`audit_log`表，可以在获取表的增量数据时获取`rowkind`列。可以使用该列进行过滤和其他操作，以完成审计。
* rowkind有四个值:
  * `+I`: 插入操作
  * `-U`: 更新操作，具有更新的行的前一个内容
  * `+U`: 更新操作，具有更新的行的新内容
  * `-D`: 删除操作

```sql
SELECT * FROM `test1$audit_log`;

/*
+------------------+-----------------+-----------------+
|     rowkind      |     column_0    |     column_1    |
+------------------+-----------------+-----------------+
|        +I        |      ...        |      ...        |
+------------------+-----------------+-----------------+
|        -U        |      ...        |      ...        |
+------------------+-----------------+-----------------+
|        +U        |      ...        |      ...        |
+------------------+-----------------+-----------------+
3 rows in set
*/
```

### Read-optimized表

*  如果需要极高的读取性能，并且可以接受读取稍旧的数据，可以使用`ro`(读取优化)系统表。读优化系统表通过只扫描不需要合并的文件来提高读性能。
* 对于主键表，`ro`系统表只扫描最顶层的文件。也就是说，每个`ro`系统表只产生最近一次完全compaction的结果。

> 不同的bucket可能在不同的时间执行full compaction，因此不同的键值可能来自不同的快照。

```sql
SELECT * FROM `test1$ro`;
```

### Files表

* 查询指定快照表的文件

```sql
-- 查询最新快照文件
SELECT * FROM `test1$files`;
/*
+-----------+--------+--------------------------------+-------------+-----------+-------+--------------+--------------------+---------+---------+-------------------+-----------------+-----------------+---------------------+---------------------+-------------------------+
| partition | bucket |                      file_path | file_format | schema_id | level | record_count | file_size_in_bytes | min_key | max_key | null_value_counts | min_value_stats | max_value_stats | min_sequence_number | max_sequence_number |           creation_time |
+-----------+--------+--------------------------------+-------------+-----------+-------+--------------+--------------------+---------+---------+-------------------+-----------------+-----------------+---------------------+---------------------+-------------------------+
|        [] |      0 | data-c3270823-5cbc-4656-9e4... |     parquet |         0 |     5 |            1 |               1004 |     [1] |     [1] |    {id=0, name=0} |  {id=1, name=1} |  {id=1, name=1} |                   3 |                   3 | 2024-08-05 19:51:19.370 |
+-----------+--------+--------------------------------+-------------+-----------+-------+--------------+--------------------+---------+---------+-------------------+-----------------+-----------------+---------------------+---------------------+-------------------------+
1 row in set (3.55 seconds)
*/
-- 查询指定快照文件
SELECT * FROM `test1$files` /*+ OPTIONS('scan.snapshot-id'='1') */;
/*
+-----------+--------+--------------------------------+-------------+-----------+-------+--------------+--------------------+---------+---------+-------------------+------------------+------------------+---------------------+---------------------+-------------------------+
| partition | bucket |                      file_path | file_format | schema_id | level | record_count | file_size_in_bytes | min_key | max_key | null_value_counts |  min_value_stats |  max_value_stats | min_sequence_number | max_sequence_number |           creation_time |
+-----------+--------+--------------------------------+-------------+-----------+-------+--------------+--------------------+---------+---------+-------------------+------------------+------------------+---------------------+---------------------+-------------------------+
|        [] |      0 | data-7c3ab572-173f-4b0c-8e7... |     parquet |         0 |     0 |            1 |               1018 |     [1] |     [1] |    {id=0, name=0} | {id=1, name=hsm} | {id=1, name=hsm} |                   0 |                   0 | 2024-07-25 19:32:15.090 |
+-----------+--------+--------------------------------+-------------+-----------+-------+--------------+--------------------+---------+---------+-------------------+------------------+------------------+---------------------+---------------------+-------------------------+
1 row in set (0.97 seconds)
*/
```

### Tags表

* 可以查询对应表的tag的历史信息，查看tag对应的快照

```sql
SELECT * FROM `test1$tags`;
/*
+----------+-------------+-----------+-------------------------+--------------+-------------+---------------+
| tag_name | snapshot_id | schema_id |             commit_time | record_count | create_time | time_retained |
+----------+-------------+-----------+-------------------------+--------------+-------------+---------------+
|   my_tag |           1 |         0 | 2024-07-25 19:32:15.142 |            1 |      <NULL> |        <NULL> |
| 20240731 |           3 |         0 | 2024-07-31 19:29:02.977 |            3 |      <NULL> |        <NULL> |
| 20240730 |           2 |         0 | 2024-07-31 19:28:36.812 |            2 |      <NULL> |        <NULL> |
| 20240729 |           1 |         0 | 2024-07-25 19:32:15.142 |            1 |      <NULL> |        <NULL> |
+----------+-------------+-----------+-------------------------+--------------+-------------+---------------+
4 rows in set (1.09 seconds)
*/
```

### Branches表

```sql
SELECT * FROM `test1$branches`;
/*
+----------------------+---------------------------+--------------------------+-------------------------+
|          branch_name |          created_from_tag |    created_from_snapshot |             create_time |
+----------------------+---------------------------+--------------------------+-------------------------+
|              branch1 |                    tag1   |                        2 | 2024-07-18 20:31:39.084 |
|              branch2 |                    tag2   |                        5 | 2024-07-18 21:11:14.373 |
+----------------------+---------------------------+--------------------------+-------------------------+
2 rows in set
*/
```

### Consumers表

* 查询包含下一个快照的所有消费者。

```sql
SELECT * FROM `test1$consumers`;
/*
+-------------+------------------+
| consumer_id | next_snapshot_id |
+-------------+------------------+
|         id1 |                1 |
|         id2 |                3 |
+-------------+------------------+
2 rows in set
*/
```

### Manifests Table

* 查询当前表的最新快照或指定快照中包含的所有manifest文件。

```sql
SELECT * FROM `test1$manifests`;

/*
+--------------------------------+-----------+-----------------+-------------------+-----------+
|                      file_name | file_size | num_added_files | num_deleted_files | schema_id |
+--------------------------------+-----------+-----------------+-------------------+-----------+
| manifest-802f8afa-28f8-457a... |      1866 |               1 |                 0 |         0 |
| manifest-ffced53d-291c-45fc... |      1867 |               1 |                 0 |         0 |
| manifest-c22f5bde-2682-4d63... |      1866 |               1 |                 0 |         0 |
| manifest-508bc98e-0623-4ffc... |      1863 |               1 |                 0 |         0 |
| manifest-93269eec-b278-4fd6... |      2069 |               1 |                 4 |         0 |
+--------------------------------+-----------+-----------------+-------------------+-----------+
5 rows in set (0.93 seconds)
*/

-- 查询指定快照
SELECT * FROM `test1$manifests` /*+ OPTIONS('scan.snapshot-id'='1') */;
/*
+--------------------------------+-----------+-----------------+-------------------+-----------+
|                      file_name | file_size | num_added_files | num_deleted_files | schema_id |
+--------------------------------+-----------+-----------------+-------------------+-----------+
| manifest-802f8afa-28f8-457a... |      1866 |               1 |                 0 |         0 |
+--------------------------------+-----------+-----------------+-------------------+-----------+
1 row in set (0.98 seconds)
*/
```

### Aggregation fields表

* 通过Aggregation fields表可以查询该表的历史聚合情况。

```sql
SELECT * FROM `test1$aggregation_fields`;

/*
+------------+-----------------+--------------+--------------------------------+---------+
| field_name |      field_type |    function  |               function_options | comment |
+------------+-----------------+--------------+--------------------------------+---------+
| product_id | BIGINT NOT NULL |           [] |                             [] |  <NULL> |
|      price |             INT | [true,count] | [fields.price.ignore-retrac... |  <NULL> |
|      sales |          BIGINT |        [sum] | [fields.sales.aggregate-fun... |  <NULL> |
+------------+-----------------+--------------+--------------------------------+---------+
3 rows in set
*/
```

### Partitions表

* 通过partitions表可以查看当前表所有分区

```sql
SELECT * FROM `test1$$partitions`;

/*
+---------------+----------------+--------------------+--------------------+------------------------+
|  partition    |   record_count |  file_size_in_bytes|          file_count|        last_update_time|
+---------------+----------------+--------------------+--------------------+------------------------+
|  [1]          |           1    |             645    |                1   | 2024-06-24 10:25:57.400|
+---------------+----------------+--------------------+--------------------+------------------------+
*/
```

## 全局System Table

* 全局系统表包含当前paimon存在的所有表的统计信息。通过一下方式访问全局系统表

```sql
USE sys;
SHOW TABLES;
+----------------------+
|           table name |
+----------------------+
|    all_table_options |
|      catalog_options |
|   sink_table_lineage |
| source_table_lineage |
+----------------------+
4 rows in set
```

### All Options Table

* 这个表类似于options表，它会显示全部db的全部paimon表的options

```sql
SELECT * FROM sys.all_table_options;

/*
+---------------+--------------------------------+--------------------------------+------------------+
| database_name |                     table_name |                            key |            value |
+---------------+--------------------------------+--------------------------------+------------------+
|         my_db |                    Orders_orc  |                         bucket |               -1 |
|         my_db |                        Orders2 |                         bucket |               -1 |
|         my_db |                        Orders2 |               sink.parallelism |                7 |
|         my_db2|                      OrdersSum |                         bucket |                1 |
+---------------+--------------------------------+--------------------------------+------------------+
7 rows in set
*/
```

### Catalog Options Table

```sql
SELECT * FROM sys.catalog_options;

/*
+-----------+---------------------------+
|       key |                     value |
+-----------+---------------------------+
| warehouse | hdfs:///path/to/warehouse |
+-----------+---------------------------+
1 rows in set
*/
```

# Write Performance

* Paimon的写入性能和Checkpoint有关，通过Checkpoint的相关配置可以提升paimon写吞吐：
  * 增大checkpoint的间隔（`execution.checkpointing.interval`），增大最大并行checkpoint个数为3（`execution.checkpointing.max-concurrent-checkpoints`），或者使用批模式写。
  * 增大`write-buffer-size`
  * 开启`write-buffer-spillable`
  * 使用固定桶模式，请重新调整桶号。
* 参数 `'changelog-producer' = 'lookup' 或 'full-compaction'`, 和参数 `'full-compaction.delta-commits'`对写入性能十分影响，如果使用快照 /完整同步阶段，则可以删除这些参数，然后在增量阶段再次启用它们。
* 如果发现运行的作业呈现锯齿状背压情况，可以尝试开启异步compaction（[Asynchronous Compaction](https://paimon.apache.org/docs/master/maintenance/write-performance/#asynchronous-compaction)）

